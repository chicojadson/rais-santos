---
title: "Mercado de Trabalho no Setor Portuário"
crossref:
  tbl-prefix: Tabela
  tbl-title: Tabela
  fig-prefix: Figura
  fig-title: Figura
filters:
  - docx-landscape.lua
language: _language-pt-BR.yml
execute:
  echo: false
format: 
  docx:
    toc: true
    toc-title: "Sumário"
    number-sections: true
    reference-doc: custom-reference-doc.docx
    fig-width: 14
    fig-height: 10
    fig-align: "center"
    lang: pt
    logo: www/logo.png
    bibliography: "https://api.citedrive.com/bib/2b128e92-3e74-4dfb-9275-4460f9b41e23/references.bib?x=eyJpZCI6ICIyYjEyOGU5Mi0zZTc0LTRkZmItOTI3NS00NDYwZjliNDFlMjMiLCAidXNlciI6ICIxMzA0MCIsICJzaWduYXR1cmUiOiAiNjlmMWNmYWRlMmFkNDJlMDQ5MjQzNzViNmU4YWJhYWM1ZDM3OWUyMmE1NjAyN2YzYzE5YzE0YmRlNjMzYWM3YSJ9"
    csl: associacao-brasileira-de-normas-tecnicas.csl
---

```{r lendo, context = "data", include=FALSE}


pacman::p_load("basedosdados", "tidyverse", 
               "dbplyr", "scales", "kableExtra", "ggrepel")

# install.packages('devtools')
# devtools::install_github('bbc/bbplot')
library(bbplot)
library(kableExtra)


#lendo os dados da rais
rais <- read_csv(file = "dados/rais.csv",
                 col_type = list(.default = "f",
                                 valor_remuneracao_media = "d",
                                 ano = "i"))

manipulacao <- function(dataset, nivel1, nivel2){
  lvls_ano = c(seq(2024,2024,1))
  dataset %>% 
  group_by({{nivel1}}, {{nivel2}}, ano) %>% # agrupamento
  summarise(n = n(), .groups = "drop") %>% #sumarização
  mutate({{nivel2}} := forcats::fct_reorder({{nivel2}}, n)) %>% # reordenamento de níveis
  arrange(desc(n)) %>% #ordenamento em ordem decrescente
  filter(!is.na({{nivel2}})) 
}



# Adicione esta linha no início do seu script se ainda não tiver
# library(stringr)

grafico <- function(dataset, 
                    nivel1, 
                    nivel2, 
                    titulo, 
                    escala_n = 1/1000,
                    sufixo_n = " mil",
                    decimal_n = ",",
                    separador_milhar = ".",
                    precisao_n = 0.01){
  
  # Função para formatar números
  formatar_numero <- function(x) {
    scales::number(
      x,
      scale = escala_n,
      decimal.mark = decimal_n,
      big.mark = separador_milhar,
      accuracy = precisao_n,
      suffix = sufixo_n
    )
  }
  
  nivel1 <- enquo(nivel1)
  nivel2 <- enquo(nivel2)
  
  # Criar versão modificada do dataset com títulos quebrados
  dataset_modificado <- dataset %>%
    mutate(
      # Quebra o texto do nível1 após 30 caracteres
      nivel1_wrapped = str_wrap(!!nivel1, width = 30)
    )
  
  # Calcular pontos máximo e mínimo
  pontos_max <- dataset_modificado %>%
    group_by(!!nivel1, !!nivel2) %>%
    filter(ano == 2024) %>%
    ungroup()
  
  pontos_min <- dataset_modificado %>%
    group_by(!!nivel1, !!nivel2) %>%
    filter(ano == 2020) %>%
    ungroup()
  
  # Identificar anos disponíveis nos dados (2024-2024)
  anos_disponiveis <- sort(unique(dataset_modificado$ano))
  
  # Definir anos para destacar (2024 e 2024 - primeiro e último)
  primeiro_ano <- min(anos_disponiveis)  # 2024
  ultimo_ano <- max(anos_disponiveis)    # 2024
  
  # Pontos para anos destacados (2024 e 2024)
  pontos_destacados <- dataset_modificado %>% 
    filter(ano %in% c(primeiro_ano, ultimo_ano))
  
  dataset_modificado %>% 
    ggplot(
      aes(
        x = ano, 
        y = n, 
        group = {{nivel2}},
        color = {{nivel2}}
      )
    ) +
    # Linhas
    geom_line(
      aes(color = {{nivel2}}),
      size = 1.5,
      alpha = 0.8
    ) +
    # Pontos em TODOS os anos (2024-2024)
    geom_point(
      color = "black", 
      size = 2.5,
      shape = 16
    ) +
    # Pontos máximo e mínimo (sobrepõe com cor diferente se necessário)
    geom_point(
      data = pontos_max,
      aes(x = ano, y = n),
      color = "black",
      size = 3,
      shape = 16
    ) +
    geom_point(
      data = pontos_min,
      aes(x = ano, y = n),
      color = "black",
      size = 3,
      shape = 16
    ) +
    labs(
      title = titulo,
      y = "Número de vínculos",
      caption = "Fonte: Observatório Portuário - Dados da RAIS",
      x = "Ano"
    ) +
    # Labels para pontos mínimos - à ESQUERDA
    geom_text_repel(
      data = pontos_min,
      aes(label = formatar_numero(n)),
      nudge_x = -0.3,
      direction = "y",
      hjust = "right",
      vjust = "center",
      size = 4,
      box.padding = 0.5,
      point.padding = 0.7,
      min.segment.length = 0.3,
      segment.color = "black",
      segment.size = 0.4,
      segment.alpha = 0.7,
      max.overlaps = 50,
      force = 1.5,
      fontface = "bold",
      family = "sans",
      color = "black"
    ) +
    # Labels para pontos máximos - à DIREITA
    geom_text_repel(
      data = pontos_max,
      aes(label = formatar_numero(n)),
      nudge_x = 0.3,
      direction = "y",
      hjust = "left",
      vjust = "center",
      size = 4,
      box.padding = 0.5,
      point.padding = 0.7,
      min.segment.length = 0.3,
      segment.color = "black",
      segment.size = 0.4,
      segment.alpha = 0.7,
      max.overlaps = 50,
      force = 1.5,
      fontface = "bold",
      family = "sans",
      color = "black"
    ) +
    

    # Labels para pontos dos anos 2024 e 2024
    # geom_text_repel(
    #   data = pontos_destacados,
    #   aes(label = formatar_numero(n)),
    #   nudge_y = 0.08,
    #   direction = "y",
    #   hjust = "center",
    #   vjust = ifelse(pontos_destacados$ano == primeiro_ano, "bottom", "top"),
    #   size = 4,
    #   box.padding = 0.3,
    #   point.padding = 0.5,
    #   min.segment.length = 0.2,
    #   segment.color = "gray40",
    #   segment.size = 0.3,
    #   segment.alpha = 0.6,
    #   max.overlaps = 30,
    #   force = 1,
    #   fontface = "bold",
    #   family = "sans",
    #   color = "black"
    # ) +
    # 
   
    # Facet
    facet_wrap(vars(nivel1_wrapped), ncol = 2, scales = "fixed") +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 18L, face = "bold", hjust = 0.5, margin = margin(b = 15)),
      plot.caption = element_text(size = 12L, face = "bold", hjust = 0, margin = margin(t = 10)), 
      axis.title.y = element_text(size = 14L, face = "bold", margin = margin(r = 10)), 
      axis.title.x = element_text(size = 14L, face = "bold", margin = margin(t = 10)),
      axis.text.x = element_text(size = 12L, face = "bold"),
      axis.text.y = element_text(size = 12L, face = "bold"),
      legend.text = element_text(size = 13L),
      legend.title = element_text(size = 14L, face = "bold"),
      panel.grid.major = element_line(color = "gray90", size = 0.3),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(fill = NA, color = "gray80", size = 0.5),
      panel.spacing = unit(1.5, "lines"),
      legend.position = "top",
      legend.justification = "center",
      legend.box = "horizontal",
      legend.margin = margin(b = 10),
      strip.text = element_text(size = 11, face = "bold", color = "black"),
      strip.background = element_rect(fill = "gray95", color = "gray80", size = 0.5),
      plot.margin = margin(20, 20, 20, 20)
    ) +
    # Escala de cores para as linhas
    scale_color_brewer(palette = "Set1", name = "Legenda:") +
    # EIXO X: Mostra apenas 2024, 2021, 2022, 2023, 2024
    scale_x_continuous(
      breaks = anos_disponiveis,  # Apenas 2024-2024
      labels = anos_disponiveis,
      expand = expansion(mult = c(0.2, 0.2))
    ) +
     # Eixo Y formatado
    scale_y_continuous(
      labels = function(x) {
        scales::number(
          x,
          scale = escala_n,
          decimal.mark = decimal_n,
          big.mark = separador_milhar,
          accuracy = precisao_n
        )
      }
    )
}
```

```{r, include=FALSE}
# Definir a ordem desejada (hierarquia educacional)
ordem_instrucao <- c(
  "Fundamental incompleto",
  "Fundamental completo",
  "Médio incompleto",
  "Médio completo",
  "Superior incompleto",
  "Superior completo",
  "Pós-graduação",
  "Mestrado",
  "Doutorado"
)

# Criar função de mapeamento
mapear_instrucao <- function(x) {
  case_when(
    x == "ANALFABETO" ~ "Analfabeto",
    x %in% c("ATE 5.A INC", "5.A CO FUND", "6. A 9. FUND") ~ "Fundamental incompleto",
    x %in% c("FUND COMPL") ~ "Fundamental completo",
    x == "MEDIO INCOMP" ~ "Médio incompleto",
    x == "MEDIO COMPL" ~ "Médio completo",
    x == "SUP. INCOMP" ~ "Superior incompleto",
    x == "SUP. COMP" ~ "Superior completo",
    x == "MESTRADO" ~ "Mestrado",
    x == "DOUTORADO" ~ "Doutorado",
    TRUE ~ "Não informado"  # Para quaisquer outros valores
  )
}

# Aplicar mapeamento e converter para fator ordenado
rais <- rais %>%
  mutate(
    grau_instrucao_apos_2005 = mapear_instrucao(grau_instrucao_apos_2005),
    grau_instrucao_apos_2005 = factor(
      grau_instrucao_apos_2005,
      levels = ordem_instrucao,
      ordered = TRUE
    )
  )

# Verificar resultado com contagem
# rais |> 
#   count(grau_instrucao_apos_2005) |> 
#   arrange(grau_instrucao_apos_2005)



virgula <- function(x) format(x, digits = 2, big.mark = ".", decimal.mark = ",")

```

```{=html}
<style>
body {
text-align: justify;
font-family: "Times New Roman";
font-size: 14px}
</style>
```

# Introdução

A Classificação Nacional de Atividades Econômicas (CNAE) organiza as atividades econômicas em 5 níveis hierárquicos: seção, divisão, grupo, classe e subclasse, conforme decrito no capítulo **Notas Metodológicas**.

O setor portuário impacta direta e indiretamente a economia do país. Seu principal objetivo da CNAE 2.0 é padronizar a forma como as atividades econômicas são codificadas no Brasil: isso facilita produção de estatísticas econômicas, cadastrais, análises econômicas e também o registro oficial de empresas conforme a atividade que exercem. Neste relatório, a CNAE será utilizada para analisar dados sobre o mercado de **trabalho portuário e aquaviário** dos municípios de **Santos e de Guarujá entre 2020 e 2024**. Trata-se, portanto, de um setor abrangente e com atividades diversas como instalações portuárias, embarcações mercantes, de passageiros, pesca, atividades em plataformas marítimas e de rerapação naval que movimentam inúmeras cadeias produtivas e setores econômicos.

Espera-se que as informações apresentadas (a metodologia está disponível na última seção) possam auxiliar o debate no setor e subsidiar a elaboração de políticas de gestão públicas e privadas.

Boa leitura.

# Panorama do trabalho no setor portuário e aquaviário em Geral

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# Calcular os valores primeiro
n_2020 <- rais |> 
  filter(ano == 2020 & id_municipio_nome == "Guarujá") |> 
  nrow()

n_2024 <- rais |> 
  filter(ano == 2024 & id_municipio_nome == "Guarujá") |> 
  nrow()

variacao <- round(((n_2024 - n_2020) / n_2020) * 100, 1)
```

Ao considerar os dados mais recentes, verifica-se que foram registrados `r rais |> group_by(ano) |> filter(ano == 2020 & id_municipio_nome == "Santos") |> count() |> pull(n) |> virgula()` vínculos em Santos em 2020, que passou para `r rais |> group_by(ano) |> filter(ano == 2024 & id_municipio_nome == "Santos") |> count() |> pull(n) |> virgula()` em 2024. Ademais, uma pessoa pode ter mais de um vínculo, por exemplo. Quanto ao município de Guarujá, constata-se que foram registrados `r rais |> group_by(ano) |> filter(ano == 2020 & id_municipio_nome == "Guarujá") |> count() |> pull(n) |> virgula()` vínculos no setor em 2020, que valor passsou para `r rais |> group_by(ano) |> filter(ano == 2024 & id_municipio_nome == "Guarujá") |> count() |> pull(n) |> virgula()` em 2024, o que representa um `r round((n_2024 - n_2020) / n_2020 * 100, 1)`%.

Os dados contemplam as divisões da RAIS **Transporte Aquaviário** (integralmente) e **Armazenamento E Atividades Auxiliares Dos Transportes** (apenas o grupo **Atividades auxiliares dos transportes aquaviários**).

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: fig-g_secao_geral
#| fig-width: 14
#| fig-height: 12
#| fig-align: "center"
#| fig-cap-location: "top"
#| fig-cap: "Vínculos do Setor Portuário e Aquaviário (2020-2024):comparação entre Santos e Guarujá"




lvls_ano <- as.character(seq(2020, 2024))


g1<-
  rais |>
  filter(!is.na(cnae_2_subclasse_descricao_secao)) |> 
  group_by(ano, id_municipio_nome, cnae_2_subclasse_descricao_secao) |> 
  summarise(n = n()) |> 
  mutate(ano = factor(ano, lvls_ano))


# Dados específicos para os dois municípios
g1 <- g1 |> 
  mutate(
    id_municipio_nome = factor(id_municipio_nome, 
                               levels = c("Santos", "Guarujá"),
                               labels = c("Santos", "Guarujá"))
  )

# Versão 1: Gráfico de colunas lado a lado (recomendado para 2 municípios)
g2 <- 
  g1 |>
  ggplot(aes(x = ano, y = n, fill = id_municipio_nome)) +
  geom_col(position = position_dodge(width = 0.8), 
           width = 0.7,
           color = "white",
           size = 0.5,
           alpha = 0.9) +
  # Valores sobre as barras
  geom_text(
    aes(label = scales::number(n, scale = 1/1000, accuracy = 0.01, suffix = " mil")),
    position = position_dodge(width = 0.8),
    vjust = -0.5,
    size = 5,
    fontface = "bold",
    color = "black"
  ) +
  # Linha de tendência
  # geom_line(
  #   aes(group = id_municipio_nome, color = id_municipio_nome),
  #   position = position_dodge(width = 0.8),
  #   size = 1,
  #   alpha = 0.7,
  #   show.legend = FALSE
  # ) +
  geom_point(
    aes(color = id_municipio_nome),
    position = position_dodge(width = 0.8),
    size = 3,
    show.legend = FALSE
  ) +
  bbc_style() +
  labs(
    x = "Ano",
    y = "Número de Vínculos",
    fill = "Município",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  scale_fill_manual(
    values = c("Santos" = "#1f77b4", "Guarujá" = "#ff7f0e")
  ) +
  scale_color_manual(
    values = c("Santos" = "#1f77b4", "Guarujá" = "#ff7f0e")
  ) +
  scale_y_continuous(
    labels = scales::label_number(scale = 1/1000, suffix = " mil"),
    expand = expansion(mult = c(0, 0.15)),  # Mais espaço para os labels
    limits = c(0, max(g1$n) * 1.15)
  ) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 18, face = "bold"),
    legend.text = element_text(size = 16),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(size = rel(2.0), face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = rel(2.3), hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = rel(1.3)),
    axis.text = element_text(size = rel(1.2)),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid.major.y = element_line(color = "gray90", size = 0.3),
    panel.grid.major.x = element_blank(),
    plot.caption = element_text(size = rel(1.0), color = "gray50", hjust = 0)
  ) +
  guides(
    fill = guide_legend(title.position = "top", title.hjust = 0.5)
  )

# Exibir gráfico
g2

      

```

# Panorama do trabalho no setor portuário e aquaviário em Santos

Ao analisar a divis\]ap **TRANSPORTE AQUAVIÁRIO**, constata-se que o grupo **Navegação de apoio** seguiu em crescimento ao longo do período analisado, saindo do valor de `r rais |> filter(id_municipio_nome == "Santos" & cnae_2_subclasse_descricao_grupo == "Navegação de apoio" & ano == 2020) |> count() |> pull() |> virgula()` vínculos em 2020 para `r rais |> filter(id_municipio_nome == "Santos" & cnae_2_subclasse_descricao_grupo == "Navegação de apoio" & ano == 2024) |> count() |> pull() |> virgula()` em 2024

```{r ,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: fig-g_secao_santos_grupo_transporte_aqua
#| fig-width: 14
#| fig-height: 12
#| fig-align: "center"
#| fig-cap: "Evolução dos Vínculos do Transporte Aquaviário em Santos (2020-2024): Por grupo de atividade econômica"
#| fig-cap-location: top


lvls_ano <- as.character(seq(2020, 2024))

g1 <-
  rais |>
  filter(id_municipio_nome == "Santos" & 
         cnae_2_subclasse_descricao_divisao == "Transporte Aquaviário") |> 
  group_by(ano, id_municipio_nome, cnae_2_subclasse_descricao_grupo) |> 
  summarise(n = n()) |> 
  mutate(ano = factor(ano, lvls_ano))



# Gráfico de linhas
g2 <- 
  g1 |>
  ggplot(aes(x = ano, y = n, group = cnae_2_subclasse_descricao_grupo)) +
  # Linhas
  geom_line(aes(color = cnae_2_subclasse_descricao_grupo), 
            size = 2,
            alpha = 0.8,
            lineend = "round",
            linejoin = "round") +
  # Pontos
  geom_point(aes(color = cnae_2_subclasse_descricao_grupo), 
             size = 5,
             shape = 21,
             fill = "white",
             stroke = 2) +
  # Valores nos pontos
  ggrepel::geom_label_repel(
    aes(label = scales::number(n, scale = 1/1000, accuracy = 0.01, suffix = " mil")),
    size = 6,
    fontface = "bold",
    box.padding = 0.5,
    point.padding = 0.3,
    segment.color = "gray50",
    segment.size = 0.3,
    min.segment.length = 0.2,
    show.legend = FALSE
  ) +
  bbc_style() +
  labs(
    x = "Ano",
    y = "Número de Vínculos",
    color = "Grupo de Atividade",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  scale_color_viridis_d(begin = 0.1, end = 0.9, option = "plasma") +
  scale_y_continuous(
    labels = scales::label_number(scale = 1/1000, suffix = " mil", accuracy = 0.01),
    expand = expansion(mult = c(0.1, 0.2))  # Mais espaço para labels
  ) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 16),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(size = rel(2.2), face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = rel(1.6), hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = rel(1.6)),
    axis.text = element_text(size = rel(1.6)),
    panel.grid.major.y = element_line(color = "gray90", size = 0.3),
    panel.grid.major.x = element_line(color = "gray90", size = 0.3),
    plot.caption = element_text(size = rel(1.5), color = "gray50", hjust = 0)
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE, title.position = "top", title.hjust = 0.5)
  )

# Exibir gráfico
g2

      

```

<br>

O grupo **Atividades auxiliares dos transportes aquaviários** é o único relacionado a atividades aquaviárias da Divisão de atividades econômicas **ARMAZENAMENTO E ATIVIDADES AUXILIARES DOS TRANSPORTES**. Por isso, ele será o único analisado nesta divisão

Ao analisar o grupo **Atividades auxiliares dos transportes aquaviários**, constata-se que ele saiu do valor de `r rais |> filter(id_municipio_nome == "Santos" & cnae_2_subclasse_descricao_grupo  == "Atividades auxiliares dos transportes aquaviários" & ano == 2020) |> count() |> pull() |> virgula()` vínculos em 2020 para `r rais |> filter(id_municipio_nome == "Santos" & cnae_2_subclasse_descricao_grupo  == "Atividades auxiliares dos transportes aquaviários" & ano == 2024) |> count() |> pull() |> virgula()` em 2024.

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: fig-g_secao_santos_grupo_armazenamento
#| fig-width: 14
#| fig-height: 12
#| fig-align: "center"
#| fig-cap: "Evolução dos Vínculos do Armazenamento E Atividades Auxiliares Dos Transportes em Santos (2020-2024): Por grupo de atividade econômica"
#| fig-cap-location: top



lvls_ano <- as.character(seq(2020, 2024))

g1 <-
  rais |>
  filter(id_municipio_nome == "Santos" & 
         cnae_2_subclasse_descricao_divisao == "Armazenamento E Atividades Auxiliares Dos Transportes") |> 
  group_by(ano, id_municipio_nome, cnae_2_subclasse_descricao_grupo) |> 
  summarise(n = n()) |> 
  mutate(ano = factor(ano, lvls_ano))



# Gráfico de linhas
g2 <- 
  g1 |>
  ggplot(aes(x = ano, y = n, group = cnae_2_subclasse_descricao_grupo)) +
  # Linhas
  geom_line(aes(color = cnae_2_subclasse_descricao_grupo), 
            size = 2,
            alpha = 0.8,
            lineend = "round",
            linejoin = "round") +
  # Pontos
  geom_point(aes(color = cnae_2_subclasse_descricao_grupo), 
             size = 5,
             shape = 21,
             fill = "white",
             stroke = 2) +
  # Valores nos pontos
  ggrepel::geom_label_repel(
    aes(label = scales::number(n, scale = 1/1000, accuracy = 0.01, suffix = " mil")),
    size = 6,
    fontface = "bold",
    box.padding = 0.5,
    point.padding = 0.3,
    segment.color = "gray50",
    segment.size = 0.3,
    min.segment.length = 0.2,
    show.legend = FALSE
  ) +
  bbc_style() +
  labs(

    x = "Ano",
    y = "Número de Vínculos",
    color = "Grupo de Atividade",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  scale_color_viridis_d(begin = 0.1, end = 0.9, option = "plasma") +
  scale_y_continuous(
    labels = scales::label_number(scale = 1/1000, suffix = " mil", accuracy = 0.01),
    expand = expansion(mult = c(0.1, 0.2))  # Mais espaço para labels
  ) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 16),
    legend.key.size = unit(0.8, "cm"),
    plot.title = element_text(size = rel(2.2), face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = rel(1.6), hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = rel(1.6)),
    axis.text = element_text(size = rel(1.6)),
    panel.grid.major.y = element_line(color = "gray90", size = 0.3),
    panel.grid.major.x = element_line(color = "gray90", size = 0.3),
    plot.caption = element_text(size = rel(1.5), color = "gray50", hjust = 0)
  ) +
  guides(
    color = guide_legend(nrow = 2, byrow = TRUE, title.position = "top", title.hjust = 0.5)
  )

# Exibir gráfico
g2

      

```

<br>

## Perfil do Trabalhador Portuário e Aquaviário em Santos

Ao analisar o perfil dos trabalhadores portuários e aquaviários de Santos por sexo, observa-se que a participação masculina é predominante. Em 2024, `r rais |>   filter(id_municipio_nome == "Santos" & sexo == "Masculino" & ano == 2024) |> group_by(ano, sexo) |> summarise(n = n(), .groups = "drop") |> pull(n) |> virgula()` eram homens, sendo apenas `r rais |>   filter(id_municipio_nome == "Santos" & sexo == "Feminino" & ano == 2024) |> group_by(ano, sexo) |> summarise(n = n(), .groups = "drop") |> pull(n) |> virgula()`.

```{r,echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-g_sexo_santos
#| fig-cap-location: top
#| fig-align: center
#| fig-cap: "Evolução dos Vínculos por Sexo em Santos (2020-2024): Distribuição entre masculino e feminino"


# ordem_esc <- c("Fundamental incompleto", "Fundamental completo", 
#         "Médio incompleto", "Médio completo", "Superior incompleto",
#         "Superior completo", "Pós-graduação", "Não informado")

# Dados
dados_sexo <- rais |> 
  filter(id_municipio_nome == "Santos") |> 
  group_by(ano, sexo) |> 
  summarise(n = n(), .groups = "drop") |> 
  mutate(ano = factor(ano),
    total = sum(n),
    percentual = n / total * 100,
    label_perc = paste0(round(percentual, 2), "%")
    )




# Opção 1: Gráfico de linhas (recomendado para evolução temporal)
g1 <- 
  dados_sexo |>
  ggplot(aes(x = ano, y = n, group = sexo, color = sexo)) +
  # Linhas
  geom_line(size = 2, alpha = 0.8, lineend = "round") +
  # Pontos
  geom_point(size = 5, shape = 21, fill = "white", stroke = 2) +
  # Valores
  geom_text(
    aes(label = scales::number(n, scale = 1/1000, accuracy = 0.1, suffix = " mil")),
    show.legend = F,
    vjust = -1.5,
    size = 6,
    fontface = "bold"
  ) +
  bbc_style() +
  labs(
    x = "Ano",
    y = "Número de Vínculos",
    color = "Sexo",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  scale_color_manual(
    values = c(
      "Feminino" = "#d62728",  # Rosa
      "Masculino" = "#1f77b4"  # Azul
    ),
    na.value = "#7f7f7f"
  ) +
  scale_y_continuous(
    labels = scales::label_number(scale = 1/1000, suffix = " mil"),
    expand = expansion(mult = c(0.1, 0.15))
  ) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 18, face = "bold"),
    legend.text = element_text(size = 14),
    plot.title = element_text(size = rel(1.8), face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = rel(1.6), hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = rel(1.4))
  )



# Mostrar os gráficos
g1  # Gráfico de linhas (recomendado)


```

<br>

```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
dados_sexo_escol <- rais |> 
  filter(id_municipio_nome == "Santos") |> 
  group_by(ano, sexo, grau_instrucao_apos_2005) |> 
  summarise(n = n(), .groups = "drop") |> 
  mutate(ano = factor(ano),
    total = sum(n),
    percentual = n / total * 100,
    label_perc = paste0(round(percentual, 2), "%")
    )
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Preparar dados com agrupamento de pós-graduação
dados_sexo_escol_agrupado <- rais |> 
  filter(id_municipio_nome == "Santos") |> 
  mutate(
    # Agrupar Doutorado e Mestrado em "Pós-graduação"
    grau_instrucao_agrupado = case_when(
      grau_instrucao_apos_2005 %in% c("Doutorado", "Mestrado") ~ "Pós-graduação",
      is.na(grau_instrucao_apos_2005) ~ NA_character_,
      TRUE ~ as.character(grau_instrucao_apos_2005)
    ),
    grau_instrucao_agrupado = factor(
      grau_instrucao_agrupado,
      levels = c(
        "Fundamental incompleto",
        "Fundamental completo",
        "Médio incompleto",
        "Médio completo",
        "Superior incompleto",
        "Superior completo",
        "Pós-graduação"
      ),
      ordered = TRUE
    )
  ) |> 
  group_by(ano, sexo, grau_instrucao_agrupado) |> 
  summarise(n = n(), .groups = "drop") |> 
  group_by(ano, sexo) |> 
  mutate(
    total_sexo_ano = sum(n, na.rm = TRUE),
    percentual = (n / total_sexo_ano) * 100,
    label_perc = case_when(
      percentual >= 5 ~ paste0(round(percentual), "%"),
      percentual >= 1 ~ paste0(round(percentual, 1), "%"),
      percentual > 0 ~ "<1%",
      TRUE ~ ""
    )
  ) |> 
  ungroup() |> 
  mutate(ano = factor(ano))

# Verificar a nova distribuição
# dados_sexo_escol_agrupado |> 
#   filter(!is.na(grau_instrucao_agrupado)) |>
#   group_by(grau_instrucao_agrupado) |>
#   summarise(total = sum(n)) |>
#   arrange(desc(total))
```

Ao analisar a relação entre sexo e grau de instrução, constata-se que a maioria das mulheres deste segmento possuem o ensino superior completo como o maior grau de escolaridade. Por outro lado, a maioria dos homens possuem o ensino médio completo como o mais elevado grau de instrução. Assim, ainda que as mulheres sejam minoria no setor, elas possuem, proporcionalmente, maior qualificação.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-g_sexo_escol_santos
#| fig-align: center
#| fig-cap-location: top
#| fig-cap: "Distribuição Educacional por Sexo em Santos (2020-2024): Maioria das mulheres possuem superior completo maioria dos homens possuem ensino médio completo"



# Definir ordem customizada do MAIS alto para o MAIS baixo grau
ordem_instrucao <- c(
  "Pós-graduação",          # Mais alto
  "Superior completo",      # ↓
  "Superior incompleto",    # ↓
  "Médio completo",         # ↓
  "Médio incompleto",       # ↓
  "Fundamental completo",   # ↓
  "Fundamental incompleto"  # Mais baixo
)

# Aplicar a ordem aos dados
dados_sexo_escol_agrupado <- dados_sexo_escol_agrupado |>
  mutate(
    grau_instrucao_agrupado = factor(
      grau_instrucao_agrupado,
      levels = ordem_instrucao,
      ordered = TRUE
    )
  )


# install.packages("viridis")
library(viridis)


# Calcular posições das linhas verticais entre os anos
# As posições serão entre cada par de anos: 2020|2021, 2021|2022, etc.
posicoes_linhas <- seq(1.5, length(unique(dados_sexo_escol_agrupado$ano)) - 0.5, by = 1)

g1 <- 
  dados_sexo_escol_agrupado |>
  filter(sexo %in% c("Feminino", "Masculino") & 
         !is.na(grau_instrucao_agrupado)) |>
  mutate(grau_instrucao_agrupado = fct_rev(grau_instrucao_agrupado)) |>
  
  ggplot(aes(x = ano, y = grau_instrucao_agrupado, fill = percentual)) +
  # Heatmap principal
  geom_tile(color = "white", size = 0.8, width = 0.9, height = 0.9) +
  
  # LINHAS VERTICAIS PONTILHADAS entre os anos
  geom_vline(xintercept = posicoes_linhas, 
             color = "black", 
             size = 1, 
             linetype = "dashed",
             alpha = .7) +
  
  # Valores nas células
  geom_text(aes(label = label_perc),
            color = "white",
            size = 5,
            fontface = "bold") +
  
  facet_wrap(~sexo, ncol = 2) +
  bbc_style() +
  labs(
    x = "Ano",
    y = "Grau de Instrução",
    fill = "Percentual (%)",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  scale_fill_viridis_c(
    direction = -1,
    begin = 0.1,
    end = 0.9,
    option = "plasma",
    na.value = "gray90",
    labels = scales::percent_format(scale = 1)
  ) +
  scale_x_discrete(expand = expansion(0)) +
  scale_y_discrete(expand = expansion(0)) +
  theme(
    legend.position = "right",
    legend.key.height = unit(2, "cm"),
    legend.title = element_text(size = 12, face = "bold"),
    strip.text = element_text(size = 14, face = "bold", color = "white"),
    strip.background = element_rect(fill = "#2c3e50"),
    plot.title = element_text(size = rel(1.8), face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = rel(1.4), hjust = 0.5, color = "gray40"),
    axis.text.x = element_text(size = rel(1.2)),
    axis.text.y = element_text(size = rel(1.1)),
    axis.title = element_text(size = rel(1.3)),
    panel.spacing = unit(1.5, "lines")
  )

g1

```

```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
# Cálculo da remuneração média
remuneracao_media <- rais |> 
  filter(id_municipio_nome == "Santos" & !is.na(valor_remuneracao_media)) |> 
  mutate(
    # Agrupar Doutorado e Mestrado em "Pós-graduação"
    grau_instrucao_agrupado = case_when(
      grau_instrucao_apos_2005 %in% c("Doutorado", "Mestrado") ~ "Pós-graduação",
      is.na(grau_instrucao_apos_2005) ~ NA_character_,
      TRUE ~ as.character(grau_instrucao_apos_2005)
    ),
    grau_instrucao_agrupado = factor(
      grau_instrucao_agrupado,
      levels = c(
        "Fundamental incompleto",
        "Fundamental completo",
        "Médio incompleto",
        "Médio completo",
        "Superior incompleto",
        "Superior completo",
        "Pós-graduação"
      ),
      ordered = TRUE
    )
  ) |> 
  group_by(ano, sexo, grau_instrucao_agrupado) |> 
  summarise(
    n = n(),
    remuneracao_media = mean(valor_remuneracao_media, na.rm = TRUE),
    remuneracao_mediana = median(valor_remuneracao_media, na.rm = TRUE),
    remuneracao_sd = sd(valor_remuneracao_media, na.rm = TRUE),
    remuneracao_q1 = quantile(valor_remuneracao_media, 0.25, na.rm = TRUE),
    remuneracao_q3 = quantile(valor_remuneracao_media, 0.75, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(
    ano = factor(ano),
    label_valor = scales::dollar(remuneracao_media, 
                                 prefix = "R$ ", 
                                 big.mark = ".", 
                                 decimal.mark = ",",
                                 accuracy = 0.01)
  )


```

```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
# Tabela resumo para 2024
tabela_resumo <- remuneracao_media |>
  filter(ano == "2024" & sexo %in% c("Feminino", "Masculino")) |>
  select(grau_instrucao_agrupado, sexo, n, remuneracao_media) |>
  pivot_wider(names_from = sexo, values_from = c(n, remuneracao_media)) |>
  mutate(
    diferenca_abs = remuneracao_media_Masculino - remuneracao_media_Feminino,
    diferenca_perc = (remuneracao_media_Masculino / remuneracao_media_Feminino - 1) * 100
  ) |>
  arrange(desc(remuneracao_media_Masculino))

# Formatar para exibição
tabela_resumo_formatada <- tabela_resumo |>
  mutate(
    remuneracao_media_Feminino = scales::dollar(remuneracao_media_Feminino, 
                                                prefix = "R$ ", 
                                                big.mark = ".", 
                                                decimal.mark = ","),
    remuneracao_media_Masculino = scales::dollar(remuneracao_media_Masculino, 
                                                 prefix = "R$ ", 
                                                 big.mark = ".", 
                                                 decimal.mark = ","),
    diferenca_abs = scales::dollar(diferenca_abs, 
                                   prefix = "R$ ", 
                                   big.mark = ".", 
                                   decimal.mark = ","),
    diferenca_perc = paste0(ifelse(diferenca_perc > 0, "+", ""), 
                           round(diferenca_perc, 1), "%")
  )

```


<br>

```{r, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
#| label: tbl-remuneracao-escol
#| tbl-cap: "Remuneração Média por Grau de Instrução - Santos (2020-2024)"

# install.packages("flextable")
library(flextable)
# install.packages("officer")
library(officer)
# Versão mais simples para Word
tabela_simples <- tabela_resumo |> filter(!is.na(grau_instrucao_agrupado)) |> 
  mutate(
    `Grau de Instrução` = grau_instrucao_agrupado,
    `Nº Feminino` = format(n_Feminino, big.mark = ".", decimal.mark = ","),
    `Nº Masculino` = format(n_Masculino, big.mark = ".", decimal.mark = ","),
    `R$ Médio Feminino` = scales::dollar(remuneracao_media_Feminino, 
                                         prefix = "R$ ", 
                                         big.mark = ".", 
                                         decimal.mark = ","),
    `R$ Médio Masculino` = scales::dollar(remuneracao_media_Masculino, 
                                          prefix = "R$ ", 
                                          big.mark = ".", 
                                          decimal.mark = ","),
    `Diferença (R$)` = scales::dollar(diferenca_abs, 
                                       prefix = "R$ ", 
                                       big.mark = ".", 
                                       decimal.mark = ","),
    `Diferença (%)` = paste0(ifelse(diferenca_perc > 0, "+", ""), 
                            round(diferenca_perc, 1), "%")
  ) |>
  select(`Grau de Instrução`, `Nº Feminino`, `Nº Masculino`, 
         `R$ Médio Feminino`, `R$ Médio Masculino`, 
         `Diferença (R$)`, `Diferença (%)`)

tabela_simples_flex <- flextable(tabela_simples) |>
  
  # Configurações básicas de fonte
  fontsize(size = 11, part = "all") |>  # Tamanho 11 é melhor para DOCX
  font(fontname = "Calibri", part = "all") |>  # Calibri é padrão no Word
  bold(part = "header") |>
  
  # Alinhamento
  align(align = "center", part = "header") |>
  align(align = "right", part = "body") |>  # Alinha números à direita
  align(j = 1, align = "left", part = "body") |>  # Primeira coluna à esquerda
  
  # Larguras das colunas (em polegadas - mais adequado para DOCX)
  width(width = c(2.0, 0.8, 0.8, 1.0, 1.0, 1.0, 0.8)) |>
  
  # Formatação condicional (se tiver colunas numéricas)
  # Exemplo para colunas monetárias:
  # colformat_num(j = c(4,5), big.mark = ".", decimal.mark = ",", prefix = "R$ ") |>
  
  # Estilo
  bg(part = "header", bg = "#4472C4") |>  # Azul corporativo padrão
  color(part = "header", color = "white") |>
  
  # Bordas
  border_outer(border = fp_border(color = "black", width = 1)) |>
  border_inner_h(border = fp_border(color = "gray", width = 0.5)) |>
  border_inner_v(border = fp_border(color = "gray", width = 0.5)) |>
  
  # Altura das linhas
  height(height = 0.3, part = "body") |>
  height(height = 0.4, part = "header") |>
  
  # Propriedades da tabela - IMPORTANTE para DOCX
  set_table_properties(layout = "fixed")  # "fixed" funciona melhor no Word

# Para visualizar no console durante o desenvolvimento
tabela_simples_flex

```

```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
#| label: tbl-remuneracao-sexo
#| tbl-cap: "Remuneração Média por Sexo e Raça - Santos (2020-2024)"

# Análise completa de renda por sexo e raça/cor
renda_sexo_raca <- rais |> 
  filter(id_municipio_nome == "Santos" & !is.na(valor_remuneracao_media)) |> 
  group_by(ano, sexo, raca_cor) |> 
  summarise(
    n = n(),
    media_geral = mean(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(
    ano = factor(ano),
    label_valor = scales::dollar(media_geral, 
                                 prefix = "R$ ", 
                                 big.mark = ".", 
                                 decimal.mark = ","),
    label_n = paste0("n=", format(n, big.mark = ".", decimal.mark = ","))
  )

# Ver resultados
# print(renda_sexo_raca, n = 30)

# Resumo estatístico
resumo_raca <- renda_sexo_raca |> 
  group_by(raca_cor, sexo) |> 
  summarise(
    media_geral = mean(media_geral),
    n_total = sum(n),
    .groups = "drop"
  ) |> 
  arrange(desc(media_geral))

# print(resumo_raca)
  
```

```{r, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
#| label: fig-g_renda_sexo_raca
#| fig-align: center
#| fig-cap-location: top
#| fig-cap: "EVOLUÇÃO TEMPORAL DA REMUNERAÇÃO MÉDIA (2020-2024):Análise por Raça/Cor e Sexo - Município de Santos"


# Versão com mais recursos visuais

# Calcular variação 2020-2024
variacao_2020_2024 <- renda_sexo_raca %>%
  filter(ano %in% c("2020", "2024")) %>%
  select(ano, raca_cor, sexo, media_geral) %>%
  pivot_wider(
    names_from = ano,
    values_from = media_geral
  ) %>%
  mutate(
    variacao_abs = `2024` - `2020`,
    variacao_perc = (`2024` / `2020` - 1) * 100,
    label_variacao = paste0(
      ifelse(variacao_perc > 0, "+", ""),
      round(variacao_perc, 1), "%"
    )
  )

# Preparar dados para labels
labels_2020 <- renda_sexo_raca %>%
  filter(ano == "2020") %>%
  mutate(
    label = paste0("2020:\nR$ ", format(round(media_geral, 0), 
                                       big.mark = ".", 
                                       decimal.mark = ",")),
    x_pos = 0.8  # Posição à esquerda
  )

labels_2024 <- renda_sexo_raca %>%
  filter(ano == "2024") %>%
  mutate(
    label = paste0("2024:\nR$ ", format(round(media_geral, 0), 
                                       big.mark = ".", 
                                       decimal.mark = ",")),
    x_pos = 4.2  # Posição à direita
  )

# Junta todos os labels
todos_labels <- bind_rows(labels_2020, labels_2024)

# Gráfico expandido com labels organizados
ggplot(renda_sexo_raca, 
       aes(x = as.numeric(as.character(ano)),  # Converter para numérico para mais controle
           y = media_geral,
           group = sexo)) +
  
  # Área de fundo para destacar período
  annotate("rect",
           xmin = 2019.5, xmax = 2024.5,
           ymin = -Inf, ymax = Inf,
           alpha = 0.03, fill = "gray90") +
  
  # Linhas principais MAIS GROSSAS
  geom_line(aes(color = sexo), 
            linewidth = 2,
            alpha = 0.9) +
  
  # Pontos GRANDES
  geom_point(aes(size = n, color = sexo, fill = sexo), 
             alpha = 0.7,
             shape = 21,
             stroke = .1) +
  
  # FACET com MAIS ESPAÇO
  facet_wrap(~ raca_cor, 
             ncol = 3,
             scales = "fixed") +
  
  # LABELS 2020 (ESQUERDA) - com fundo
  geom_label(
    data = labels_2020,
    aes(x = x_pos, y = media_geral, 
        label = label, fill = sexo),
    color = "black",
    size = 4,
    fontface = "bold",
    hjust = 1,
    label.size = 0.5,
    label.padding = unit(0.4, "lines"),
    alpha = 0.8,
    show.legend = FALSE
  ) +
  
  # LABELS 2024 (DIREITA) - com fundo
  geom_label(
    data = labels_2024,
    aes(x = x_pos, y = media_geral, 
        label = label, fill = sexo),
    color = "black",
    size = 4,
    fontface = "bold",
    hjust = 0,
    label.size = 0.5,
    label.padding = unit(0.4, "lines"),
    alpha = 0.8,
    show.legend = FALSE
  ) +
  
  # Linhas conectando pontos aos labels (opcional)
  geom_segment(
    data = labels_2020,
    aes(x = as.numeric(as.character(ano)), xend = x_pos - 0.1,
        y = media_geral, yend = media_geral,
        color = sexo),
    linetype = "dashed",
    alpha = 0.3,
    linewidth = 0.5,
    show.legend = FALSE
  ) +
  
  geom_segment(
    data = labels_2024,
    aes(x = as.numeric(as.character(ano)), xend = x_pos + 0.1,
        y = media_geral, yend = media_geral,
        color = sexo),
    linetype = "dashed",
    alpha = 0.3,
    linewidth = 0.5,
    show.legend = FALSE
  ) +
  
  # Escalas - EXPANDIDAS
  scale_x_continuous(
    breaks = c(2020, 2021, 2022, 2023, 2024),
    labels = c("2020", "2021", "2022", "2023", "2024"),
    limits = c(2019, 2025),  # LIMITES EXPANDIDOS
    expand = expansion(mult = c(0.2, 0.2))  # 20% de expansão em cada lado
  ) +
  
  scale_y_continuous(
    labels = label_dollar(prefix = "R$ ", 
                         big.mark = ".", 
                         decimal.mark = ","),
  ) +
  
  scale_color_manual(
    values = c("Feminino" = "#d62728",
               "Masculino" = "#1f77b4"),
    name = "SEXO",
    guide = guide_legend(
      title.position = "top",
      title.hjust = 0.5,
      keywidth = unit(1.5, "cm")
    )
  ) +
  
  scale_fill_manual(
    values = c("Feminino" = "#d62728",
               "Masculino" = "#1f77b4"),
    guide = "none"
  ) +
  
  scale_size_continuous(
    range = c(4, 12),
    name = "NÚMERO DE OBSERVAÇÕES",
    breaks = c(100, 1000, 5000),
    labels = function(x) format(x, big.mark = ".", decimal.mark = ","),
    guide = guide_legend(
      title.position = "top",
      title.hjust = 0.5,
      nrow = 1
    )
  ) +
  
  # Labels
  labs(
    x = "ANO",
    y = "REMUNERAÇÃO MÉDIA (R$)",
    caption = paste(
      "Fonte: Observatório Portuário - Dados da RAIS/Ministério do Trabalho"
    )
  ) +
  
  # Tema completamente expandido
  theme_minimal(base_size = 15) +
  theme(
    # Títulos
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5,
                             margin = margin(b = 15)),
    plot.subtitle = element_text(size = 14, color = "gray40", hjust = 0.5,
                                margin = margin(b = 20), lineheight = 1.2),
    plot.caption = element_text(size = 11, color = "gray50", hjust = 0,
                               margin = margin(t = 20)),
    
    # Eixos
    axis.title = element_text(size = 16, face = "bold"),
    axis.title.x = element_text(margin = margin(t = 20)),
    axis.title.y = element_text(margin = margin(r = 20)),
    axis.text = element_text(size = 13),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 13,
                               margin = margin(t = 10)),
    axis.text.y = element_text(size = 13),
    
    # Facets com MUITO espaço
    strip.text = element_text(size = 13, face = "bold", 
                             margin = margin(t = 8, b = 8)),
    strip.background = element_rect(fill = "#e8f0ff", color = "gray70",
                                   linewidth = 0.8,  height = unit(0.6, "cm")),
    
    # Legendas
    legend.title = element_text(size = 14, face = "bold", 
                               margin = margin(b = 8)),
    legend.text = element_text(size = 13),
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.spacing.x = unit(2, "cm"),
    legend.margin = margin(t = 15, b = 15),
    
    # Grade e painéis
    panel.grid.major = element_line(color = "gray85", linewidth = 0.6),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(2.5, "lines"),  # ESPAÇO MÁXIMO ENTRE FACETS
    
    # Margens do plot
    plot.margin = margin(30, 40, 30, 40),  # MARGENS LATERAIS MAIORES
    plot.background = element_rect(fill = "white", color = NA)
  )
```




<br>


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#| label: tbl-tabela_resumo_santos
#| tbl-cap-location: top
#| tbl-cap: "Renda Média por Sexo em Santos"


library(flextable)
library(dplyr)
library(scales)

# Primeiro, vamos criar os dados resumidos corretamente
# Dados por sexo
renda_por_sexo <- rais |> 
  filter(id_municipio_nome == "Santos" & !is.na(valor_remuneracao_media)) |> 
  group_by(ano, sexo) |> 
  summarise(
    n = n(),
    media_remuneracao = mean(valor_remuneracao_media, na.rm = TRUE),
    mediana = median(valor_remuneracao_media, na.rm = TRUE),
    desvio_padrao = sd(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(ano = factor(ano))

# Dados gerais (todos os sexos)
renda_geral <- rais |> 
  filter(id_municipio_nome == "Santos" & !is.na(valor_remuneracao_media)) |> 
  group_by(ano) |> 
  summarise(
    n = n(),
    media_remuneracao = mean(valor_remuneracao_media, na.rm = TRUE),
    mediana = median(valor_remuneracao_media, na.rm = TRUE),
    desvio_padrao = sd(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(
    ano = factor(ano),
    sexo = "Geral"
  )

# Combinar os dados
renda_completa <- bind_rows(
  renda_por_sexo,
  renda_geral |> select(ano, sexo, n, media_remuneracao, mediana, desvio_padrao)
) |> 
  arrange(ano, sexo)


# Primeiro ver os nomes das colunas após o pivot_wider
tabela_intermediaria <- renda_completa |>
  pivot_wider(
    id_cols = ano,
    names_from = sexo,
    values_from = c(n, media_remuneracao, mediana, desvio_padrao),
    names_glue = "{sexo}_{.value}"
  )



# Agora corrigir o select com os nomes corretos
tabela_resumo <- tabela_intermediaria |>
  select(
    ano,
    # Feminino
    n_Feminino = `Feminino_n`,  # Ajustar nome
    media_remuneracao_Feminino = `Feminino_media_remuneracao`,
    mediana_Feminino = `Feminino_mediana`,
    desvio_padrao_Feminino = `Feminino_desvio_padrao`,
    # Masculino
    n_Masculino = `Masculino_n`,
    media_remuneracao_Masculino = `Masculino_media_remuneracao`,
    mediana_Masculino = `Masculino_mediana`,
    desvio_padrao_Masculino = `Masculino_desvio_padrao`,
    # Geral
    n_Geral = `Geral_n`,
    media_remuneracao_Geral = `Geral_media_remuneracao`,
    mediana_Geral = `Geral_mediana`,
    desvio_padrao_Geral = `Geral_desvio_padrao`
  ) |>
  mutate(
    # Calcular diferenças
    diff_fem_masc = media_remuneracao_Masculino - media_remuneracao_Feminino,
    diff_perc_fem_masc = (media_remuneracao_Masculino / media_remuneracao_Feminino - 1) * 100,
    
    # Diferença feminino em relação ao geral
    diff_fem_geral = (media_remuneracao_Feminino / media_remuneracao_Geral - 1) * 100,
    
    # Diferença masculino em relação ao geral
    diff_masc_geral = (media_remuneracao_Masculino / media_remuneracao_Geral - 1) * 100
  )

# Versão alternativa mais simples
tabela_resumo_simples <- renda_completa |>
  pivot_wider(
    id_cols = ano,
    names_from = sexo,
    values_from = c(n, media_remuneracao),
    names_glue = "{sexo}_{.value}"
  ) |>
  rename(
    n_F = `Feminino_n`,
    media_F = `Feminino_media_remuneracao`,
    n_M = `Masculino_n`,
    media_M = `Masculino_media_remuneracao`,
    n_G = `Geral_n`,
    media_G = `Geral_media_remuneracao`
  ) |>
  mutate(
    diff_abs = media_M - media_F,
    diff_perc = (media_M / media_F - 1) * 100
  )

# Formatar para tabela Word
tabela_formatada <- tabela_resumo_simples |>
  mutate(
    Ano = as.character(ano),
    `N (F)` = format(n_F, big.mark = ".", decimal.mark = ","),
    `Média (F)` = scales::dollar(media_F, 
                                 prefix = "R$ ", 
                                 big.mark = ".", 
                                 decimal.mark = ","),
    `N (M)` = format(n_M, big.mark = ".", decimal.mark = ","),
    `Média (M)` = scales::dollar(media_M, 
                                 prefix = "R$ ", 
                                 big.mark = ".", 
                                 decimal.mark = ","),
    `N (Geral)` = format(n_G, big.mark = ".", decimal.mark = ","),
    `Média (Geral)` = scales::dollar(media_G, 
                                     prefix = "R$ ", 
                                     big.mark = ".", 
                                     decimal.mark = ","),
    `Dif. Absoluta` = scales::dollar(diff_abs, 
                                     prefix = "R$ ", 
                                     big.mark = ".", 
                                     decimal.mark = ","),
    `Dif. Percentual` = paste0(ifelse(diff_perc > 0, "+", ""), 
                              round(diff_perc, 1), "%")
  ) |>
  select(
    Ano,
    `N (F)`, `Média (F)`,
    `N (M)`, `Média (M)`,
    `N (Geral)`, `Média (Geral)`,
    `Dif. Absoluta`, `Dif. Percentual`
  )

# Criar flextable
library(flextable)
library(officer)

tabela_word <- flextable(tabela_formatada) |>
  
  # 1. PRIMEIRO definir os cabeçalhos básicos
  set_header_labels(
    Ano = "Ano",
    `N (F)` = "N",
    `Média (F)` = "Média R$",
    `N (M)` = "N",
    `Média (M)` = "Média R$",
    `N (Geral)` = "N",
    `Média (Geral)` = "Média R$",
    `Dif. Absoluta` = "Absoluta",
    `Dif. Percentual` = "Percentual"
  ) |>
  
  # 2. DEPOIS adicionar o cabeçalho agrupado
  add_header_row(
    top = TRUE,
    values = c("", "FEMININO", "MASCULINO", "GERAL", "DIFERENÇAS"),
    colwidths = c(1, 2, 2, 2, 2)
  ) |>
  
  # 3. Formatação básica
  fontsize(size = 10, part = "all") |>  # 10 ou 11 para DOCX
  font(fontname = "Calibri", part = "all") |>  # Calibri é padrão Word
  bold(part = "header") |>
  
  # 4. Alinhamento - IMPORTANTE para DOCX
  align(align = "center", part = "header") |>
  align(j = 1, align = "left", part = "body") |>  # Ano à esquerda
  align(j = c(2, 4, 6), align = "right", part = "body") |>  # Valores N à direita
  align(j = c(3, 5, 7, 8), align = "center", part = "body") |>  # Médias e diferenças ao centro
  
  # 5. Larguras ajustadas para DOCX (em polegadas)
  width(width = c(0.6, 0.4, 0.9, 0.4, 0.9, 0.4, 0.9, 0.9, 0.9)) |>
  
  # 6. Estilo e cores
  bg(part = "header", bg = "#2c3e50") |>
  color(part = "header", color = "white") |>
  
  # 7. Bordas (mais visíveis no Word)
  border_outer(border = fp_border(color = "black", width = 1.5)) |>
  border_inner_h(border = fp_border(color = "gray80", width = 0.75)) |>
  border_inner_v(border = fp_border(color = "gray80", width = 0.75)) |>
  
  # 8. Altura das linhas para melhor visualização
  height(height = 0.3, part = "body") |>
  height_all(height = 0.4, part = "header") |>  # Altura do cabeçalho
  
  # 9. Cores condicionais (corrigindo a sintaxe)
  color(i = ~ grepl("^\\+", `Dif. Percentual`), 
        j = "Dif. Percentual", 
        color = "#d62728") |>  # Vermelho para positivo
  color(i = ~ grepl("^-", `Dif. Percentual`), 
        j = "Dif. Percentual", 
        color = "#1f77b4") |>  # Azul para negativo
  
  # 10. Configurações finais para DOCX
  set_table_properties(layout = "fixed") |>  # Fixo funciona melhor no Word
  
  # 11. Título e rodapé
  set_caption("Tabela: Remuneração Média por Sexo - Santos (2020-2024)") |>
  add_footer_lines("Fonte: Observatório Portuário - Dados da RAIS") |>
  fontsize(part = "footer", size = 9) |>
  align(part = "footer", align = "left") |>
  
  # 12. Ajuste automático final (opcional)
  autofit(add_w = 0.1, add_h = 0.1)  # Pequeno ajuste automático

# Para mostrar no Quarto
tabela_word


```

## Perfil do Trabalhador Portuário e Aquaviário em Guarujá

Ao analisar o perfil dos trabalhadores portuários e aquaviários de Guarujá por sexo, observa-se que a participação masculina também é predominante. Em 2024, `r rais |> filter(id_municipio_nome == "Guarujá" & sexo == "Masculino" & ano == 2024) |> group_by(ano, sexo) |> summarise(n = n(), .groups = "drop") |> pull(n) |> virgula()` eram homens, sendo apenas `r rais |> filter(id_municipio_nome == "Guarujá" & sexo == "Feminino" & ano == 2024) |> group_by(ano, sexo) |> summarise(n = n(), .groups = "drop") |> pull(n) |> virgula()` mulheres.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: fig-vincu-guaruja
#| fig-cap: "Evolução dos Vínculos por Sexo em Guarujá (2020-2024): Distribuição entre masculino e feminino"
#| fig-align: center
#| fig-cap-location: top

#|fig
dados_sexo_guaruja <- rais |> 
  filter(id_municipio_nome == "Guarujá") |> 
  group_by(ano, sexo) |> 
  summarise(n = n(), .groups = "drop") |> 
  mutate(
    ano = factor(ano),
    total = sum(n),
    percentual = n / total * 100,
    label_perc = paste0(round(percentual, 2), "%")
  )

# Gráfico de evolução para Guarujá
g1_guaruja <- dados_sexo_guaruja |>
  ggplot(aes(x = ano, y = n, group = sexo, color = sexo)) +
  geom_line(size = 2, alpha = 0.8, lineend = "round") +
  geom_point(size = 5, shape = 21, fill = "white", stroke = 2) +
  geom_text(
    aes(label = scales::number(n, scale = 1/1000, accuracy = 0.1, suffix = " mil")),
    show.legend = F,
    vjust = -1.5,
    size = 6,
    fontface = "bold"
  ) +
  bbc_style() +
  labs(
    x = "Ano",
    y = "Número de Vínculos",
    color = "Sexo",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  scale_color_manual(
    values = c("Feminino" = "#d62728", "Masculino" = "#1f77b4"),
    na.value = "#7f7f7f"
  ) +
  scale_y_continuous(
    labels = scales::label_number(scale = 1/1000, suffix = " mil"),
    expand = expansion(mult = c(0.1, 0.15))
  ) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 18, face = "bold"),
    legend.text = element_text(size = 14),
    plot.title = element_text(size = rel(1.8), face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = rel(1.6), hjust = 0.5, color = "gray40"),
    axis.title = element_text(size = rel(1.4))
  )

g1_guaruja
```


Ao analisar a relação entre sexo e grau de instrução em Guarujá, observa-se padrões similares aos de Santos. As mulheres, apesar de minoria no setor, apresentam maior proporção com ensino superior completo, enquanto a maioria dos homens possui ensino médio completo como nível educacional mais elevado.

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: fig-dados_sexo_escol_guaruj
#| fig-align: center
#| fig-cap-location: top
#| fig-cap: "Distribuição Educacional por Sexo em Guarujá (2020-2024): Perfil similar a Santos: mulheres com maior qualificação educacional"

# Dados educação Guarujá
dados_sexo_escol_guaruja <- rais |> 
  filter(id_municipio_nome == "Guarujá") |> 
  mutate(
    grau_instrucao_agrupado = case_when(
      grau_instrucao_apos_2005 %in% c("Doutorado", "Mestrado") ~ "Pós-graduação",
      is.na(grau_instrucao_apos_2005) ~ NA_character_,
      TRUE ~ as.character(grau_instrucao_apos_2005)
    ),
    grau_instrucao_agrupado = factor(
      grau_instrucao_agrupado,
      levels = c(
        "Fundamental incompleto",
        "Fundamental completo",
        "Médio incompleto",
        "Médio completo",
        "Superior incompleto",
        "Superior completo",
        "Pós-graduação"
      ),
      ordered = TRUE
    )
  ) |> 
  group_by(ano, sexo, grau_instrucao_agrupado) |> 
  summarise(n = n(), .groups = "drop") |> 
  group_by(ano, sexo) |> 
  mutate(
    total_sexo_ano = sum(n, na.rm = TRUE),
    percentual = (n / total_sexo_ano) * 100,
    label_perc = case_when(
      percentual >= 5 ~ paste0(round(percentual), "%"),
      percentual >= 1 ~ paste0(round(percentual, 1), "%"),
      percentual > 0 ~ "<1%",
      TRUE ~ ""
    )
  ) |> 
  ungroup() |> 
  mutate(ano = factor(ano))

# Ordem da instrução
ordem_instrucao <- c(
  "Pós-graduação", "Superior completo", "Superior incompleto",
  "Médio completo", "Médio incompleto", "Fundamental completo", "Fundamental incompleto"
)

# Aplicar ordem
dados_sexo_escol_guaruja <- dados_sexo_escol_guaruja |>
  mutate(
    grau_instrucao_agrupado = factor(
      grau_instrucao_agrupado,
      levels = ordem_instrucao,
      ordered = TRUE
    )
  )

# Posições das linhas verticais
posicoes_linhas <- seq(1.5, length(unique(dados_sexo_escol_guaruja$ano)) - 0.5, by = 1)

# Heatmap educação Guarujá
g2_guaruja <- dados_sexo_escol_guaruja |>
  filter(sexo %in% c("Feminino", "Masculino") & !is.na(grau_instrucao_agrupado)) |>
  mutate(grau_instrucao_agrupado = fct_rev(grau_instrucao_agrupado)) |>
  ggplot(aes(x = ano, y = grau_instrucao_agrupado, fill = percentual)) +
  geom_tile(color = "white", size = 0.8, width = 0.9, height = 0.9) +
  geom_vline(xintercept = posicoes_linhas, color = "black", size = 1, linetype = "dashed", alpha = .7) +
  geom_text(aes(label = label_perc), color = "white", size = 5, fontface = "bold") +
  facet_wrap(~sexo, ncol = 2) +
  bbc_style() +
  labs(
    x = "Ano",
    y = "Grau de Instrução",
    fill = "Percentual (%)",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  scale_fill_viridis_c(direction = -1, begin = 0.1, end = 0.9, option = "plasma",
                      na.value = "gray90", labels = scales::percent_format(scale = 1)) +
  scale_x_discrete(expand = expansion(0)) +
  scale_y_discrete(expand = expansion(0)) +
  theme(
    legend.position = "right",
    legend.key.height = unit(2, "cm"),
    legend.title = element_text(size = 12, face = "bold"),
    strip.text = element_text(size = 14, face = "bold", color = "white"),
    strip.background = element_rect(fill = "#2c3e50"),
    plot.title = element_text(size = rel(1.8), face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = rel(1.4), hjust = 0.5, color = "gray40"),
    axis.text.x = element_text(size = rel(1.2)),
    axis.text.y = element_text(size = rel(1.1)),
    axis.title = element_text(size = rel(1.3)),
    panel.spacing = unit(1.5, "lines")
  )

g2_guaruja
```

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# Remuneração média Guarujá
remuneracao_media_guaruja <- rais |> 
  filter(id_municipio_nome == "Guarujá" & !is.na(valor_remuneracao_media)) |> 
  mutate(
    grau_instrucao_agrupado = case_when(
      grau_instrucao_apos_2005 %in% c("Doutorado", "Mestrado") ~ "Pós-graduação",
      is.na(grau_instrucao_apos_2005) ~ NA_character_,
      TRUE ~ as.character(grau_instrucao_apos_2005)
    ),
    grau_instrucao_agrupado = factor(
      grau_instrucao_agrupado,
      levels = c("Fundamental incompleto", "Fundamental completo", "Médio incompleto",
                 "Médio completo", "Superior incompleto", "Superior completo", "Pós-graduação"),
      ordered = TRUE
    )
  ) |> 
  group_by(ano, sexo, grau_instrucao_agrupado) |> 
  summarise(
    n = n(),
    remuneracao_media = mean(valor_remuneracao_media, na.rm = TRUE),
    remuneracao_mediana = median(valor_remuneracao_media, na.rm = TRUE),
    remuneracao_sd = sd(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(
    ano = factor(ano),
    label_valor = scales::dollar(remuneracao_media, prefix = "R$ ", 
                                big.mark = ".", decimal.mark = ",")
  )
```

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: tbl-remuneracao-escol-guaruja
#| tbl-cap: "Tabela 3: Remuneração Média por Grau de Instrução - Guarujá (2020-2024)"
#| tbl-cap-location: top

# Tabela resumo Guarujá 2024
tabela_resumo_guaruja <- remuneracao_media_guaruja |>
  filter(ano == "2024" & sexo %in% c("Feminino", "Masculino")) |>
  select(grau_instrucao_agrupado, sexo, n, remuneracao_media) |>
  pivot_wider(names_from = sexo, values_from = c(n, remuneracao_media)) |>
  mutate(
    diferenca_abs = remuneracao_media_Masculino - remuneracao_media_Feminino,
    diferenca_perc = (remuneracao_media_Masculino / remuneracao_media_Feminino - 1) * 100
  ) |>
  arrange(desc(remuneracao_media_Masculino))

# Tabela formatada
tabela_simples_guaruja <- tabela_resumo_guaruja |> 
  filter(!is.na(grau_instrucao_agrupado)) |> 
  mutate(
    `Grau de Instrução` = grau_instrucao_agrupado,
    `Nº Feminino` = format(n_Feminino, big.mark = ".", decimal.mark = ","),
    `Nº Masculino` = format(n_Masculino, big.mark = ".", decimal.mark = ","),
    `R$ Médio Feminino` = scales::dollar(remuneracao_media_Feminino, 
                                         prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    `R$ Médio Masculino` = scales::dollar(remuneracao_media_Masculino, 
                                          prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    `Diferença (R$)` = scales::dollar(diferenca_abs, 
                                       prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    `Diferença (%)` = paste0(ifelse(diferenca_perc > 0, "+", ""), 
                            round(diferenca_perc, 1), "%")
  ) |>
  select(`Grau de Instrução`, `Nº Feminino`, `Nº Masculino`, 
         `R$ Médio Feminino`, `R$ Médio Masculino`, 
         `Diferença (R$)`, `Diferença (%)`)

# Tabela flextable
tabela_guaruja_flex <- flextable(tabela_simples_guaruja) |>
  fontsize(size = 11, part = "all") |>
  font(fontname = "Calibri", part = "all") |>
  bold(part = "header") |>
  align(align = "center", part = "header") |>
  align(align = "right", part = "body") |>
  align(j = 1, align = "left", part = "body") |>
  width(width = c(2.0, 0.8, 0.8, 1.0, 1.0, 1.0, 0.8)) |>
  bg(part = "header", bg = "#4472C4") |>
  color(part = "header", color = "white") |>
  border_outer(border = fp_border(color = "black", width = 1)) |>
  border_inner_h(border = fp_border(color = "gray", width = 0.5)) |>
  border_inner_v(border = fp_border(color = "gray", width = 0.5)) |>
  height(height = 0.3, part = "body") |>
  height(height = 0.4, part = "header") |>
  set_table_properties(layout = "fixed") |>
  set_caption("Tabela 3: Remuneração Média por Grau de Instrução - Guarujá (2024)")

tabela_guaruja_flex
```

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# Dados raça/cor Guarujá
renda_sexo_raca_guaruja <- rais |> 
  filter(id_municipio_nome == "Guarujá" & !is.na(valor_remuneracao_media)) |> 
  group_by(ano, sexo, raca_cor) |> 
  summarise(
    n = n(),
    media_geral = mean(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(
    ano = factor(ano),
    label_valor = scales::dollar(media_geral, prefix = "R$ ", 
                                big.mark = ".", decimal.mark = ","),
    label_n = paste0("n=", format(n, big.mark = ".", decimal.mark = ","))
  )
```



<br>

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: fig-raca-sexo-guaruja
#| fig-cap: "Evolução da Remuneração Média por Raça/Cor e Sexo - Guarujá (2020-2024)"
#| fig-align: center
#| fig-cap-location: top

# Preparar labels para 2020 e 2024
labels_2020_guaruja <- renda_sexo_raca_guaruja %>%
  filter(ano == "2020") %>%
  mutate(
    label = paste0("2020:\nR$ ", format(round(media_geral, 0), 
                                       big.mark = ".", decimal.mark = ",")),
    x_pos = 0.8
  )

labels_2024_guaruja <- renda_sexo_raca_guaruja %>%
  filter(ano == "2024") %>%
  mutate(
    label = paste0("2024:\nR$ ", format(round(media_geral, 0), 
                                       big.mark = ".", decimal.mark = ",")),
    x_pos = 4.2
  )

# Gráfico raça/cor Guarujá
ggplot(renda_sexo_raca_guaruja, 
       aes(x = as.numeric(as.character(ano)), y = media_geral, group = sexo)) +
  
  # Linhas
  geom_line(aes(color = sexo), linewidth = 1.8, alpha = 0.9) +
  
  # Pontos
  geom_point(aes(size = n, color = sexo, fill = sexo), 
             alpha = 0.7, shape = 21, stroke = 0.3) +
  
  # Facets
  facet_wrap(~ raca_cor, ncol = 3, scales = "fixed") +
  
  # Labels 2020
  geom_label(
    data = labels_2020_guaruja,
    aes(x = x_pos, y = media_geral, label = label, fill = sexo),
    color = "black", size = 3.5, fontface = "bold",
    hjust = 1, label.size = 0.3, label.padding = unit(0.3, "lines"),
    alpha = 0.8, show.legend = FALSE
  ) +
  
  # Labels 2024
  geom_label(
    data = labels_2024_guaruja,
    aes(x = x_pos, y = media_geral, label = label, fill = sexo),
    color = "black", size = 3.5, fontface = "bold",
    hjust = 0, label.size = 0.3, label.padding = unit(0.3, "lines"),
    alpha = 0.8, show.legend = FALSE
  ) +
  
  # Escalas
  scale_x_continuous(
    breaks = c(2020, 2021, 2022, 2023, 2024),
    labels = c("2020", "2021", "2022", "2023", "2024"),
    limits = c(2019, 2025),
    expand = expansion(mult = c(0.2, 0.2))
  ) +
  
  scale_y_continuous(
    labels = label_dollar(prefix = "R$ ", big.mark = ".", decimal.mark = ",")
  ) +
  
  scale_color_manual(
    values = c("Feminino" = "#d62728", "Masculino" = "#1f77b4"),
    name = "Sexo"
  ) +
  
  scale_fill_manual(
    values = c("Feminino" = "#d62728", "Masculino" = "#1f77b4"),
    guide = "none"
  ) +
  
  scale_size_continuous(
    range = c(2, 8),
    name = "Nº de Observações",
    breaks = c(10, 100, 1000),
    labels = function(x) format(x, big.mark = ".", decimal.mark = ",")
  ) +
  
  # Labels
  labs(
    title = "EVOLUÇÃO DA REMUNERAÇÃO MÉDIA POR RAÇA/COR E SEXO",
    subtitle = "Análise comparativa da desigualdade salarial em Guarujá (2020-2024)",
    x = "Ano",
    y = "Remuneração Média (R$)",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  
  # Tema
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 10)),
    plot.subtitle = element_text(size = 13, color = "gray40", hjust = 0.5, margin = margin(b = 15)),
    plot.caption = element_text(size = 11, color = "gray50", hjust = 0, margin = margin(t = 15)),
    axis.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(margin = margin(t = 15)),
    axis.title.y = element_text(margin = margin(r = 15)),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    strip.text = element_text(size = 12, face = "bold", margin = margin(t = 8, b = 8)),
    strip.background = element_rect(fill = "#e8f0ff", color = "gray70", 
                                   linewidth = 0.8, height = unit(0.5, "cm")),
    legend.position = "bottom",
    legend.box = "horizontal",
    legend.spacing.x = unit(1, "cm"),
    legend.margin = margin(t = 10, b = 10),
    panel.grid.major = element_line(color = "gray90", linewidth = 0.4),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(1.5, "lines"),
    plot.margin = margin(25, 30, 25, 30),
    plot.background = element_rect(fill = "white", color = NA)
  )
```



<br>

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: tbl-remuneracao-sexo-guaruja
#| tbl-cap: "Tabela 4: Remuneração Média por Sexo - Guarujá (2020-2024)"
#| tbl-cap-location: top


# Tabela comparativa Guarujá
renda_por_sexo_guaruja <- rais |> 
  filter(id_municipio_nome == "Guarujá" & !is.na(valor_remuneracao_media)) |> 
  group_by(ano, sexo) |> 
  summarise(
    n = n(),
    media_remuneracao = mean(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(ano = factor(ano))

renda_geral_guaruja <- rais |> 
  filter(id_municipio_nome == "Guarujá" & !is.na(valor_remuneracao_media)) |> 
  group_by(ano) |> 
  summarise(
    n = n(),
    media_remuneracao = mean(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  ) |> 
  mutate(ano = factor(ano), sexo = "Geral")

renda_completa_guaruja <- bind_rows(
  renda_por_sexo_guaruja,
  renda_geral_guaruja |> select(ano, sexo, n, media_remuneracao)
) |> 
  arrange(ano, sexo)

tabela_resumo_simples_guaruja <- renda_completa_guaruja |>
  pivot_wider(
    id_cols = ano,
    names_from = sexo,
    values_from = c(n, media_remuneracao),
    names_glue = "{sexo}_{.value}"
  ) |>
  rename(
    n_F = `Feminino_n`,
    media_F = `Feminino_media_remuneracao`,
    n_M = `Masculino_n`,
    media_M = `Masculino_media_remuneracao`,
    n_G = `Geral_n`,
    media_G = `Geral_media_remuneracao`
  ) |>
  mutate(
    diff_abs = media_M - media_F,
    diff_perc = (media_M / media_F - 1) * 100
  )

tabela_formatada_guaruja <- tabela_resumo_simples_guaruja |>
  mutate(
    Ano = as.character(ano),
    `N (F)` = format(n_F, big.mark = ".", decimal.mark = ","),
    `Média (F)` = scales::dollar(media_F, prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    `N (M)` = format(n_M, big.mark = ".", decimal.mark = ","),
    `Média (M)` = scales::dollar(media_M, prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    `N (Geral)` = format(n_G, big.mark = ".", decimal.mark = ","),
    `Média (Geral)` = scales::dollar(media_G, prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    `Dif. Absoluta` = scales::dollar(diff_abs, prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    `Dif. Percentual` = paste0(ifelse(diff_perc > 0, "+", ""), round(diff_perc, 1), "%")
  ) |>
  select(Ano, `N (F)`, `Média (F)`, `N (M)`, `Média (M)`, 
         `N (Geral)`, `Média (Geral)`, `Dif. Absoluta`, `Dif. Percentual`)

# Flextable Guarujá
tabela_guaruja_comparativa <- flextable(tabela_formatada_guaruja) |>
  set_header_labels(
    Ano = "Ano",
    `N (F)` = "N", `Média (F)` = "Média R$",
    `N (M)` = "N", `Média (M)` = "Média R$",
    `N (Geral)` = "N", `Média (Geral)` = "Média R$",
    `Dif. Absoluta` = "Absoluta", `Dif. Percentual` = "Percentual"
  ) |>
  add_header_row(
    top = TRUE,
    values = c("", "FEMININO", "MASCULINO", "GERAL", "DIFERENÇAS"),
    colwidths = c(1, 2, 2, 2, 2)
  ) |>
  fontsize(size = 10, part = "all") |>
  font(fontname = "Calibri", part = "all") |>
  bold(part = "header") |>
  align(align = "center", part = "header") |>
  align(j = 1, align = "left", part = "body") |>
  align(j = c(2, 4, 6), align = "right", part = "body") |>
  align(j = c(3, 5, 7, 8), align = "center", part = "body") |>
  width(width = c(0.6, 0.4, 0.9, 0.4, 0.9, 0.4, 0.9, 0.9, 0.9)) |>
  bg(part = "header", bg = "#2c3e50") |>
  color(part = "header", color = "white") |>
  border_outer(border = fp_border(color = "black", width = 1.5)) |>
  border_inner_h(border = fp_border(color = "gray80", width = 0.75)) |>
  border_inner_v(border = fp_border(color = "gray80", width = 0.75)) |>
  height(height = 0.3, part = "body") |>
  height_all(height = 0.4, part = "header") |>
  color(i = ~ grepl("^\\+", `Dif. Percentual`), j = "Dif. Percentual", color = "#d62728") |>
  color(i = ~ grepl("^-", `Dif. Percentual`), j = "Dif. Percentual", color = "#1f77b4") |>
  set_table_properties(layout = "fixed") |>
  set_caption("Tabela 4: Remuneração Média por Sexo - Guarujá (2020-2024)") |>
  add_footer_lines("Fonte: Observatório Portuário - Dados da RAIS") |>
  fontsize(part = "footer", size = 9) |>
  align(part = "footer", align = "left")

tabela_guaruja_comparativa
```

### Comparativo entre Santos e Guarujá

```{r,  echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
#| label: fig-comparativo-santos-guaruja
#| fig-cap: "Comparativo entre Santos e Guarujá - Remuneração Média (2024)"
#| fig-align: center
#| fig-cap-location: top

# Dados comparativos 2024
comparativo_2024 <- rais |> 
  filter(id_municipio_nome %in% c("Santos", "Guarujá") & 
         ano == 2024 & !is.na(valor_remuneracao_media)) |> 
  group_by(id_municipio_nome, sexo) |> 
  summarise(
    n = n(),
    media_remuneracao = mean(valor_remuneracao_media, na.rm = TRUE),
    .groups = "drop"
  )

# Gráfico comparativo
ggplot(comparativo_2024, 
       aes(x = id_municipio_nome, y = media_remuneracao, fill = sexo)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.7) +
  geom_text(aes(label = scales::dollar(media_remuneracao, prefix = "R$ ",
                                      big.mark = ".", decimal.mark = ",")),
            position = position_dodge(width = 0.8),
            vjust = -0.5, size = 4.5, fontface = "bold") +
  geom_text(aes(label = paste0("n=", format(n, big.mark = "."))),
            position = position_dodge(width = 0.8),
            vjust = 1.5, size = 3.5, color = "white", fontface = "bold") +
  scale_y_continuous(
    labels = label_dollar(prefix = "R$ ", big.mark = ".", decimal.mark = ","),
    expand = expansion(mult = c(0, 0.15))
  ) +
  scale_fill_manual(values = c("Feminino" = "#d62728", "Masculino" = "#1f77b4")) +
  labs(
    x = "Município",
    y = "Remuneração Média (R$)",
    fill = "Sexo",
    caption = "Fonte: Observatório Portuário - Dados da RAIS"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, color = "gray40", hjust = 0.5),
    axis.title = element_text(size = 13, face = "bold"),
    axis.text = element_text(size = 12),
    legend.position = "top"
  )
```
